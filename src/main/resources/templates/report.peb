<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>smAIrtRx - {% if isHighDetail %}Full Report{% else %}Report{% endif %}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 30px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        h2, h3 { color: #333; }
        .disclaimer { font-style: italic; color: #666; margin-top: 10px; }
        .stats-container { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .stat-box { border: 1px solid #ccc; padding: 15px; border-radius: 5px; background-color: #f9f9f9; min-width: 150px; flex: 1; }
        .stat-value { font-size: 1.5em; font-weight: bold; color: #007bff; }
        .stat-label { font-size: 0.9em; color: #555; }
        .pill { background-color: #e9ecef; padding: 2px 8px; border-radius: 12px; font-size: 0.9em; }
        .pill.bad { background-color: #f8d7da; color: #721c24; }
        .pill.warning { background-color: #fff3cd; color: #856404; }
        .definitions { background-color: #f1f1f1; padding: 15px; border-radius: 5px; margin-top: 40px; }
        .stats-table-container { overflow-x: auto; }
        .chart-container { margin-bottom: 40px; background: #fff; border: 1px solid #ddd; padding: 20px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>smAIrtRx - {% if isHighDetail %}Full Audit Report{% else %}Report{% endif %}</h1>

    {% include "fragments/summary.peb" %}

    {% include "fragments/statistics-table.peb" with {"stats": globalStats, "title": "Global Aggregate Performance Matrix"} %}

    {% if globalStats.procedureComparisons is not null and not (globalStats.procedureComparisons is empty) %}
        {% include "fragments/comparison-table.peb" %}
    {% endif %}

    {% if showSummaryGraph %}
        <div class="chart-container">
            <canvas id="execSummaryChart"></canvas>
        </div>
    {% endif %}

    {% for ss in siteStats %}
        {% include "fragments/statistics-table.peb" with {"stats": ss, "title": "Site Analysis: " ~ ss.name} %}
        {% if showDetailGraph %}
            <div class="chart-container">
                <canvas id="{{ siteToCanvasId[ss.name] }}"></canvas>
            </div>
        {% endif %}
    {% endfor %}

    {% include "fragments/weekly-summary.peb" %}

    <div class="definitions" style="margin-top: 20px; background-color: #f8fafc; border-left: 5px solid #3b82f6;">
        <h3 style="margin-top: 0; color: #2563eb;">‚ÑπÔ∏è Regional Staffing Model</h3>
        <p style="font-size: 0.9em; margin-bottom: 0;">
            CRNA staffing is calculated using a regional pool model, acknowledging that CRNAs can float between facilities. However, surgical procedures and surgeons remain site-bound due to equipment requirements and logistics.
        </p>
    </div>

    {% if not isLowDetail %}
        {% include "fragments/daily-details.peb" %}
    {% endif %}

    {% if invalidRows is not null and not (invalidRows is empty) and not isLowDetail %}
        {% include "fragments/ignored-cases.peb" %}
    {% endif %}

    {% include "fragments/definitions.peb" %}
    
    {% if verificationSample is not null %}
    <div class="chart-container" style="background-color: #f8fafc; border-left: 5px solid #2563eb; margin-top: 40px;">
        <h2 style="margin-top: 0;">üîç CFO Verification Sample</h2>
        <p>The following actual data from this dataset demonstrates the mathematical proof for OR consolidation:</p>
        
        <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0;">
            <p>At site <strong>{{ verificationSample.siteName }}</strong> there were <strong>{{ verificationSample.baselineRooms }}</strong> ORs utilized in this dataset. On <strong>{{ verificationSample.date }}</strong>, procedures from the below ORs were moved to other ORs. This consolidation eliminated these <strong>{{ verificationSample.roomsSaved }}</strong> physical OR requirement(s) for this day:</p>
            
            <ul style="list-style: none; padding-left: 0;">
                {% for room in verificationSample.roomConsolidationDetails %}
                {% if room.wasEliminated %}
                <li style="margin-bottom: 10px; padding: 15px; border-radius: 6px; background: #fff1f2; border: 1px dashed #f43f5e;">
                    <strong>{{ room.originalRoomName }}</strong>: {{ room.procedureCount }} procedure(s) over {{ room.totalMinutes }} minutes 
                    <span style="color: #e11d48; font-weight: bold; margin-left: 10px;">(OR unused for the day after moving procedures to other ORs)</span>
                </li>
                {% endif %}
                {% endfor %}
            </ul>
            
            <p style="margin-top: 20px; font-weight: bold; color: #16a34a; font-size: 1.1em;">
                ‚úÖ Result: Through temporal stacking and safety buffer verification, the above procedures were consolidated, safely eliminating {{ verificationSample.roomsSaved }} physical OR requirement(s) for this day.
            </p>
        </div>
    </div>
    {% endif %}

    {% include "fragments/charts.peb" %}
</body>
</html>
